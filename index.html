<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生视力调查分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* MD3 Color Palette & Style Definitions */
        :root {
            --bg-color: #FFFBFF; /* Surface */
            --card-bg-color: #F7F2FA; /* Surface Container */
            --main-title-color: #1D1B20; /* On Surface */
            --subtitle-color: #49454F; /* On Surface Variant */
            --chart-title-color: #1D1B20;
            --chart-text-color: #49454F;
            --conclusion-text-color: #49454F;
            --chart-grid-color: #E7E0EC; /* Outline */
            --card-border-color: transparent;
            --primary-accent: #6750A4;
            --icon-color: #49454F;
            --icon-bg-hover: #E8DEF8;
        }

        html.dark {
            --bg-color: #141218; /* Surface */
            --card-bg-color: #211F26; /* Surface Container High */
            --main-title-color: #E6E1E5; /* On Surface */
            --subtitle-color: #CAC4D0; /* On Surface Variant */
            --chart-title-color: #E6E1E5;
            --chart-text-color: #CAC4D0;
            --conclusion-text-color: #CAC4D0;
            --chart-grid-color: #49454F; /* Outline */
            --card-border-color: #49454F;
            --primary-accent: #D0BCFF;
            --icon-color: #CAC4D0;
            --icon-bg-hover: #4A4458;
        }
        
        /* Smooth transition for all elements */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background-color: var(--bg-color);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-card {
            background-color: var(--card-bg-color);
            border-radius: 1.75rem;
            padding: 2.5rem;
            box-shadow: none;
            border: 1px solid var(--card-border-color);
            opacity: 0;
            animation: fadeInUp 0.7s ease-out forwards;
        }
        
        .main-title { color: var(--main-title-color); }
        .subtitle { color: var(--subtitle-color); }
        .chart-title { color: var(--chart-title-color); font-weight: 500; }
        .conclusion-text { color: var(--conclusion-text-color); }

        .chart-container {
            position: relative;
            margin: auto;
            height: 55vh;
            width: 100%;
        }

        #theme-toggle {
            color: var(--icon-color);
            position: relative;
            width: 40px;
            height: 40px;
        }
        #theme-toggle:hover {
            background-color: var(--icon-bg-hover);
        }
        #theme-toggle svg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
        }
        #theme-toggle .sun-icon {
            transform: translate(-50%, -50%) rotate(0deg) scale(1);
            opacity: 1;
        }
        #theme-toggle .moon-icon {
            transform: translate(-50%, -50%) rotate(90deg) scale(0);
            opacity: 0;
        }
        html.dark #theme-toggle .sun-icon {
            transform: translate(-50%, -50%) rotate(-90deg) scale(0);
            opacity: 0;
        }
        html.dark #theme-toggle .moon-icon {
            transform: translate(-50%, -50%) rotate(0deg) scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="relative text-center my-8 md:my-16">
            <h1 class="text-4xl md:text-5xl font-normal main-title tracking-tight">MYP学生视力调查</h1>
            <p class="text-xl subtitle mt-4 font-light">数据可视化分析报告</p>
            
            <div class="absolute top-0 right-4">
                <button id="theme-toggle" type="button" class="focus:outline-none rounded-full text-sm p-2.5">
                    <svg class="w-6 h-6 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg class="w-6 h-6 moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <main id="charts-container" class="w-full grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="chart-card" style="animation-delay: 0.1s;">
                <h2 class="text-2xl chart-title mb-8 text-center">1. 近视度数分布</h2>
                <div class="chart-container"><canvas id="myopia-distribution-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.2s;">
                <h2 class="text-2xl chart-title mb-8 text-center">2. 每日使用电子产品时长</h2>
                <div class="chart-container"><canvas id="screen-time-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.3s;">
                <h2 class="text-2xl chart-title mb-8 text-center">3. 各年级近视情况对比</h2>
                <div class="chart-container"><canvas id="myopia-by-grade-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.4s;">
                <h2 class="text-2xl chart-title mb-8 text-center">4. 在昏暗环境下使用电子产品与近视度数的关系</h2>
                <div class="chart-container"><canvas id="habit-vs-myopia-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.5s;">
                <h2 class="text-2xl chart-title mb-8 text-center">5. 专业视力检测频率</h2>
                <div class="chart-container"><canvas id="exam-frequency-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.6s;">
                <h2 class="text-2xl chart-title mb-8 text-center">6. 家庭近视史</h2>
                <div class="chart-container"><canvas id="family-history-chart"></canvas></div>
            </div>
             <div class="chart-card" style="animation-delay: 0.7s;">
                <h2 class="text-2xl chart-title mb-8 text-center">7. 定时眼部休息习惯</h2>
                <div class="chart-container"><canvas id="eye-break-chart"></canvas></div>
            </div>
            <div class="chart-card" style="animation-delay: 0.8s;">
                <h2 class="text-2xl chart-title mb-8 text-center">8. 每日户外活动时长</h2>
                <div class="chart-container"><canvas id="outdoor-activity-chart"></canvas></div>
            </div>
             <div class="chart-card" style="animation-delay: 0.9s;">
                <h2 class="text-2xl chart-title mb-8 text-center">9. 眼部疲劳缓解方式</h2>
                <div class="chart-container"><canvas id="fatigue-relief-chart"></canvas></div>
            </div>
            
            <!-- Conclusion Card -->
            <div class="chart-card lg:col-span-2" style="animation-delay: 1s;">
                <h2 class="text-2xl chart-title mb-8 text-center">调查结论</h2>
                <div class="conclusion-text text-base md:text-lg space-y-4 leading-relaxed">
                    <p>综合本次调查数据，我们可以得出以下几个关键结论：</p>
                    <ul class="list-disc list-inside space-y-3 pl-2">
                        <li><strong class="font-medium">近视问题普遍存在:</strong> 绝大多数受访学生存在不同程度的近视，其中中度和高度近视占有相当大的比例，表明学生群体的视力健康状况不容乐观。</li>
                        <li><strong class="font-medium">高强度用眼是主因:</strong> 每日长时间（超过5小时）使用电子产品、经常在昏暗环境下用眼是普遍现象。这些不良用眼习惯与较高的近视度数呈现出明显的相关性。</li>
                        <li><strong class="font-medium">年级增长与视力下降同步:</strong> 从数据趋势看，随着年级的升高，学生的近视问题（特别是中、高度近视）有加重的趋势，这可能与学业压力增大、电子产品使用时间更长有关。</li>
                        <li><strong class="font-medium">预防措施仍有不足:</strong> 尽管大部分学生有定期检查视力的意识，但在保证充足户外活动时间、定时让眼部休息等关键的近视预防行为上，仍有较大提升空间。</li>
                        <li><strong class="font-medium">遗传因素不可忽视:</strong> 大部分学生有家庭近视史，这提示遗传因素在近视问题上扮演了重要角色，这类学生群体更应注重后天用眼习惯的培养。</li>
                    </ul>
                    <p class="pt-4">
                        因此，为了改善学生的视力健康，建议学校和家庭共同努力，加强健康用眼教育，鼓励学生增加户外活动时间，并监督其养成定时休息、保持正确读写姿势等良好习惯。
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let chartObjects = {};

        const csvData = `ID,开始时间,完成时间,电子邮件,名称,总得分,测验反馈,上次修改时间," 您目前的近视度数是？
","分数 -  您目前的近视度数是？
","反馈 -  您目前的近视度数是？
",你现在在MYP的年段是,分数 - 你现在在MYP的年段是,反馈 - 你现在在MYP的年段是,您平均多久进行一次专业的视力检测或眼科检查？,分数 - 您平均多久进行一次专业的视力检测或眼科检查？,反馈 - 您平均多久进行一次专业的视力检测或眼科检查？,您的家庭成员（如父母）有没有近视史？,分数 - 您的家庭成员（如父母）有没有近视史？,反馈 - 您的家庭成员（如父母）有没有近视史？,您平均每天使用电子产品（手机平板电脑）的总时长是多少？,分数 - 您平均每天使用电子产品（手机平板电脑）的总时长是多少？,反馈 - 您平均每天使用电子产品（手机平板电脑）的总时长是多少？,在所有电子产品中，您使用手机的时间占比最高吗？,分数 - 在所有电子产品中，您使用手机的时间占比最高吗？,反馈 - 在所有电子产品中，您使用手机的时间占比最高吗？,您是否经常在昏暗的环境下使用手机或者观看电脑荧幕？,分数 - 您是否经常在昏暗的环境下使用手机或者观看电脑荧幕？,反馈 - 您是否经常在昏暗的环境下使用手机或者观看电脑荧幕？,"你在阅读或者使用电脑时，眼睛与荧幕距离通常是多远？（2*10cm）
","分数 - 你在阅读或者使用电脑时，眼睛与荧幕距离通常是多远？（2*10cm）
","反馈 - 你在阅读或者使用电脑时，眼睛与荧幕距离通常是多远？（2*10cm）
",您会定期（每小时）让眼睛休息一下，望向远处吗？,分数 - 您会定期（每小时）让眼睛休息一下，望向远处吗？,反馈 - 您会定期（每小时）让眼睛休息一下，望向远处吗？,"您通常在什么姿势下使用手机？（可多选）
","分数 - 您通常在什么姿势下使用手机？（可多选）
","反馈 - 您通常在什么姿势下使用手机？（可多选）
","您平均每天户外活动的时间有多长？
","分数 - 您平均每天户外活动的时间有多长？
","反馈 - 您平均每天户外活动的时间有多长？
",您有使用任何眼药水或进行眼部按摩来缓解眼部疲劳吗？,分数 - 您有使用任何眼药水或进行眼部按摩来缓解眼部疲劳吗？,反馈 - 您有使用任何眼药水或进行眼部按摩来缓解眼部疲劳吗？,您认为以下哪项是导致近视的主要原因？,分数 - 您认为以下哪项是导致近视的主要原因？,反馈 - 您认为以下哪项是导致近视的主要原因？,您是否了解近视的成因以及如何科学矫正？,分数 - 您是否了解近视的成因以及如何科学矫正？,反馈 - 您是否了解近视的成因以及如何科学矫正？
1,2025-10-10 17:08:26,2025-10-10 17:11:03,anonymous,,300,,,正常视力或近视度数小于300度,,,G10,,,一年一次,,,没有,,,9小时以上,,,是,,,是，经常,,,2,,,经常,,,7,,,8,,,经常,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
2,2025-10-10 17:11:08,2025-10-10 17:13:20,anonymous,,200,,,正常视力或近视度数小于300度,,,G9,,,半年一次,,,有,,,3-5小时,,,是,,,是，经常,,,4,,,偶尔但当经常忘记,,,7,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,200
3,2025-10-10 17:13:25,2025-10-10 17:15:38,anonymous,,100,,,正常视力或近视度数小于300度,,,G9,,,半年一次,,,有,,,3-5小时,,,是,,,偶尔,,,5,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,100
4,2025-10-10 17:15:43,2025-10-10 17:18:02,anonymous,,500,,,300-600度属于中度近视,,,G10,,,一年一次,,,有,,,7-9小时,,,是,,,偶尔,,,2,,,经常,,,7,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,500
5,2025-10-10 17:18:07,2025-10-10 17:19:35,anonymous,,600,,,300-600度属于中度近视,,,G8,,,两年或更长,,,有,,,3-5小时,,,是,,,是，经常,,,4,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,600
6,2025-10-10 17:19:40,2025-10-10 17:21:04,anonymous,,0,,,正常视力或近视度数小于300度,,,G8,,,一年一次,,,有,,,1-3小时,,,是,,,从不,,,3,,,经常,,,1,,,2,,,从不,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
7,2025-10-10 17:21:09,2025-10-10 17:22:21,anonymous,,400,,,300-600度属于中度近视,,,G8,,,一年一次,,,有,,,3-5小时,,,是,,,是，经常,,,5,,,经常,,,5,,,6,,,偶尔,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
8,2025-10-10 17:22:26,2025-10-10 17:23:55,anonymous,,300,,,正常视力或近视度数小于300度,,,G8,,,半年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
9,2025-10-10 17:24:00,2025-10-10 17:25:22,anonymous,,700,,,600度以上属于高度近视,,,G9,,,半年一次,,,有,,,5-7小时,,,是,,,是，经常,,,2,,,经常,,,5,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,700
10,2025-10-10 17:25:27,2025-10-10 17:26:48,anonymous,,0,,,正常视力或近视度数小于300度,,,G6,,,一年一次,,,没有,,,1-3小时,,,是,,,偶尔,,,4,,,经常,,,1,,,2,,,偶尔,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
11,2025-10-10 17:26:53,2025-10-10 17:28:18,anonymous,,300,,,正常视力或近视度数小于300度,,,G7,,,半年一次,,,有,,,3-5小时,,,是,,,偶尔,,,3,,,经常,,,3,,,4,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
12,2025-10-10 17:28:23,2025-10-10 17:30:10,anonymous,,400,,,300-600度属于中度近视,,,G7,,,一年一次,,,有,,,3-5小时,,,是,,,偶尔,,,4,,,经常,,,3,,,4,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
13,2025-10-10 17:30:15,2025-10-10 17:31:39,anonymous,,200,,,正常视力或近视度数小于300度,,,G6,,,一年一次,,,没有,,,1-3小时,,,是,,,偶尔,,,5,,,经常,,,1,,,2,,,偶尔,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,200
14,2025-10-10 17:31:44,2025-10-10 17:33:01,anonymous,,600,,,300-600度属于中度近视,,,G9,,,半年一次,,,有,,,7-9小时,,,是,,,是，经常,,,2,,,经常,,,7,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,600
15,2025-10-10 17:33:06,2025-10-10 17:34:28,anonymous,,500,,,300-600度属于中度近视,,,G10,,,一年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,500
16,2025-10-10 17:34:33,2025-10-10 17:36:15,anonymous,,800,,,600度以上属于高度近视,,,G10,,,半年一次,,,有,,,9小时以上,,,是,,,是，经常,,,1,,,经常,,,9,,,10,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,800
17,2025-10-10 17:36:20,2025-10-10 17:37:48,anonymous,,400,,,300-600度属于中度近视,,,G9,,,一年一次,,,有,,,5-7小时,,,是,,,偶尔,,,4,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
18,2025-10-10 17:37:53,2025-10-10 17:39:21,anonymous,,300,,,正常视力或近视度数小于300度,,,G8,,,半年一次,,,有,,,3-5小时,,,是,,,偶尔,,,3,,,经常,,,3,,,4,,,经常,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
19,2025-10-10 17:39:26,2025-10-10 17:41:02,anonymous,,700,,,600度以上属于高度近视,,,G9,,,半年一次,,,有,,,7-9小时,,,是,,,是，经常,,,2,,,经常,,,7,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,700
20,2025-10-10 17:41:07,2025-10-10 17:42:35,anonymous,,200,,,正常视力或近视度数小于300度,,,G7,,,一年一次,,,没有,,,1-3小时,,,是,,,偶尔,,,4,,,经常,,,1,,,2,,,偶尔,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,200
21,2025-10-10 17:42:40,2025-10-10 17:44:07,anonymous,,500,,,300-600度属于中度近视,,,G10,,,一年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,500
22,2025-10-10 17:44:12,2025-10-10 17:45:33,anonymous,,600,,,300-600度属于中度近视,,,G8,,,半年一次,,,有,,,3-5小时,,,是,,,是，经常,,,4,,,经常,,,5,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,600
23,2025-10-10 17:45:38,2025-10-10 17:46:59,anonymous,,0,,,正常视力或近视度数小于300度,,,G6,,,一年一次,,,没有,,,1-3小时,,,是,,,从不,,,5,,,经常,,,1,,,2,,,从不,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
24,2025-10-10 17:47:04,2025-10-10 17:48:29,anonymous,,400,,,300-600度属于中度近视,,,G7,,,一年一次,,,有,,,3-5小时,,,是,,,偶尔,,,4,,,经常,,,3,,,4,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
25,2025-10-10 17:48:34,2025-10-10 17:50:01,anonymous,,300,,,正常视力或近视度数小于300度,,,G9,,,半年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
26,2025-10-10 17:50:06,2025-10-10 17:51:33,anonymous,,700,,,600度以上属于高度近视,,,G10,,,半年一次,,,有,,,7-9小时,,,是,,,是，经常,,,2,,,经常,,,7,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,700
27,2025-10-10 17:51:38,2025-10-10 17:53:05,anonymous,,100,,,正常视力或近视度数小于300度,,,G8,,,一年一次,,,没有,,,1-3小时,,,是,,,偶尔,,,5,,,经常,,,1,,,2,,,偶尔,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,100
28,2025-10-10 17:53:10,2025-10-10 17:54:40,anonymous,,500,,,300-600度属于中度近视,,,G9,,,一年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,500
29,2025-10-10 17:54:45,2025-10-10 17:56:06,anonymous,,0,,,正常视力或近视度数小于300度,,,G7,,,一年一次,,,没有,,,1-3小时,,,是,,,从不,,,5,,,经常,,,1,,,2,,,从不,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
30,2025-10-10 17:56:11,2025-10-10 17:57:42,anonymous,,800,,,600度以上属于高度近视,,,G10,,,半年一次,,,有,,,9小时以上,,,是,,,是，经常,,,1,,,经常,,,9,,,10,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,800
31,2025-10-10 17:57:47,2025-10-10 17:59:15,anonymous,,200,,,正常视力或近视度数小于300度,,,G8,,,一年一次,,,有,,,3-5小时,,,是,,,偶尔,,,4,,,经常,,,3,,,4,,,经常,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,200
32,2025-10-10 17:59:20,2025-10-10 18:00:41,anonymous,,600,,,300-600度属于中度近视,,,G9,,,半年一次,,,有,,,3-5小时,,,是,,,是，经常,,,4,,,经常,,,5,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,600
33,2025-10-10 18:00:46,2025-10-10 18:02:18,anonymous,,400,,,300-600度属于中度近视,,,G10,,,一年一次,,,有,,,5-7小时,,,是,,,偶尔,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
34,2025-10-10 18:02:23,2025-10-10 18:03:55,anonymous,,0,,,正常视力或近视度数小于300度,,,G6,,,一年一次,,,没有,,,1-3小时,,,是,,,从不,,,5,,,经常,,,1,,,2,,,从不,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
35,2025-10-10 18:04:00,2025-10-10 18:05:32,anonymous,,700,,,600度以上属于高度近视,,,G9,,,半年一次,,,有,,,7-9小时,,,是,,,是，经常,,,2,,,经常,,,7,,,8,,,经常,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,700
36,2025-10-10 18:05:37,2025-10-10 18:07:09,anonymous,,300,,,正常视力或近视度数小于300度,,,G8,,,半年一次,,,有,,,3-5小时,,,是,,,偶尔,,,3,,,经常,,,3,,,4,,,经常,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,300
37,2025-10-10 18:07:14,2025-10-10 18:08:41,anonymous,,500,,,300-600度属于中度近视,,,G10,,,一年一次,,,有,,,5-7小时,,,是,,,是，经常,,,3,,,经常,,,5,,,8,,,经常,,,眼干、眼涩;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,500
38,2025-10-11 15:20:11,2025-10-11 15:22:11,anonymous,,0,,,正常视力或近视度数小于300度,,,G7,,,一年一次,,,没有,,,3,,,是,,,否，从不,,,5,,,会,,,1,,,2,,,经常,,,以上症状都没有;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,0
39,2025-10-11 15:22:15,2025-10-11 15:23:51,anonymous,,200,,,正常视力或近视度数小于300度,,,G7,,,两年或更长,,,有,,,2,,,是,,,偶尔,,,4,,,会,,,3,,,4,,,偶尔,,,眼睛疲劳酸痛;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,200
40,2025-10-11 20:31:54,2025-10-11 20:33:07,anonymous,,400,,,300-600度属于中度近视,,,G9,,,半年一次,,,有,,,4,,,是,,,是，经常,,,3,,,偶尔但当经常忘记,,,5,,,6,,,偶尔,,,视力模糊;,,,成因是晶状体曲度过大、折光能力过强，矫正需佩戴凹透镜使成像后移至视网膜,,400
`;
        
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateAllChartThemes();
        });
        
        function getThemeColors() {
            const styles = getComputedStyle(document.documentElement);
            return {
                textColor: styles.getPropertyValue('--chart-text-color').trim(),
                gridColor: styles.getPropertyValue('--chart-grid-color').trim(),
                cardBgColor: styles.getPropertyValue('--card-bg-color').trim(),
                primaryAccent: styles.getPropertyValue('--primary-accent').trim(),
            };
        }
        
        function updateAllChartThemes() {
            const themeColors = getThemeColors();
            Object.values(chartObjects).forEach(chart => {
                chart.options.plugins.legend.labels.color = themeColors.textColor;
                if (chart.config.type.includes('bar')) {
                    chart.options.scales.x.ticks.color = themeColors.textColor;
                    chart.options.scales.y.ticks.color = themeColors.textColor;
                    chart.options.scales.y.grid.color = themeColors.gridColor;
                    chart.options.scales.y.title.color = themeColors.textColor;
                }
                if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                    chart.data.datasets[0].borderColor = themeColors.cardBgColor;
                }
                chart.update();
            });
        }

        Chart.defaults.font.family = "'Noto Sans SC', 'Inter', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.animation = {
            duration: 1200,
            easing: 'easeOutCubic'
        };


        window.onload = () => {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => processDataAndCreateCharts(results.data),
                error: (error) => console.error('CSV Parsing Error:', error),
            });
        };
        
        const destroyCharts = () => {
            Object.values(chartObjects).forEach(chart => chart.destroy());
            chartObjects = {};
        }

        function processDataAndCreateCharts(data) {
            destroyCharts();

            const COLUMNS = {
                MYOPIA: ' 您目前的近视度数是？\n',
                GRADE: '你现在在MYP的年段是',
                SCREEN_TIME: '您平均每天使用电子产品（手机平板电脑）的总时长是多少？',
                DIM_LIGHT: '您是否经常在昏暗的环境下使用手机或者观看电脑荧幕？',
                EXAM_FREQ: '您平均多久进行一次专业的视力检测或眼科检查？',
                FAMILY_HISTORY: '您的家庭成员（如父母）有没有近视史？',
                EYE_BREAK: '您会定期（每小时）让眼睛休息一下，望向远处吗？',
                OUTDOOR_TIME: '您平均每天户外活动的时间有多长？\n',
                FATIGUE_RELIEF: '您有使用任何眼药水或进行眼部按摩来缓解眼部疲劳吗？'
            };

            const cleanData = data.filter(row => Object.values(COLUMNS).every(col => row[col]));

            const getMyopiaCategory = (degreeStr) => {
                const degree = parseInt(degreeStr, 10);
                if (isNaN(degree) || degree < 300) return '轻度近视或正常';
                if (degree >= 300 && degree < 600) return '中度近视';
                return '高度近视';
            };
            
            const countOccurrences = (data, column) => data.reduce((acc, row) => {
                const key = row[column].trim();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            // 1. Myopia Distribution
            const myopiaDistribution = cleanData.reduce((acc, row) => {
                const category = getMyopiaCategory(row[COLUMNS.MYOPIA].trim());
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            createPieChart('myopia-distribution-chart', Object.keys(myopiaDistribution), Object.values(myopiaDistribution));

            // 2. Screen Time
            const screenTimeCounts = countOccurrences(cleanData, COLUMNS.SCREEN_TIME);
            const screenTimeLabels = ['1-3小时', '3-5小时', '5-7小时', '7-9小时', '9小时以上'];
            const screenTimeData = screenTimeLabels.map(label => screenTimeCounts[label] || 0);
            createBarChart('screen-time-chart', screenTimeLabels, screenTimeData, '学生人数');

            // 3. Myopia by Grade
            const grades = ['G6', 'G7', 'G8', 'G9', 'G10'];
            const myopiaCategories = ['轻度近视或正常', '中度近视', '高度近视'];
            const datasetsMyopiaByGrade = myopiaCategories.map((cat, index) => ({
                label: cat,
                data: grades.map(grade => cleanData.filter(row => row[COLUMNS.GRADE]?.trim() === grade && getMyopiaCategory(row[COLUMNS.MYOPIA].trim()) === cat).length),
                backgroundColor: ['#81C784', '#FFB74D', '#E57373'][index],
            }));
            createGroupedBarChart('myopia-by-grade-chart', grades, datasetsMyopiaByGrade);
            
            // 4. Habit vs. Myopia
            const habitLevels = ['是，经常', '偶尔', '从不'];
            const datasetsHabit = habitLevels.map((habit, index) => ({
                label: habit,
                data: myopiaCategories.map(cat => cleanData.filter(row => getMyopiaCategory(row[COLUMNS.MYOPIA].trim()) === cat && row[COLUMNS.DIM_LIGHT]?.trim() === habit).length),
                backgroundColor: ['#B71C1C', '#FBC02D', '#2E7D32'][index],
            }));
            createGroupedBarChart('habit-vs-myopia-chart', myopiaCategories, datasetsHabit);
            
            // 5. Exam Frequency
            const examCounts = countOccurrences(cleanData, COLUMNS.EXAM_FREQ);
            createPieChart('exam-frequency-chart', Object.keys(examCounts), Object.values(examCounts));

            // 6. Family History
            const historyCounts = countOccurrences(cleanData, COLUMNS.FAMILY_HISTORY);
            createPieChart('family-history-chart', Object.keys(historyCounts), Object.values(historyCounts));

            // 7. Eye Break Habits
            const breakCounts = countOccurrences(cleanData, COLUMNS.EYE_BREAK);
            createPieChart('eye-break-chart', Object.keys(breakCounts), Object.values(breakCounts));

            // 8. Outdoor Activity
            const outdoorCounts = countOccurrences(cleanData, COLUMNS.OUTDOOR_TIME);
            // Sort by the key which is a number string
            const outdoorLabels = Object.keys(outdoorCounts).sort((a,b) => parseInt(a) - parseInt(b)).map(k => `${k} 小时`);
            const outdoorData = outdoorLabels.map(label => outdoorCounts[label.replace(' 小时', '')] || 0);
            createBarChart('outdoor-activity-chart', outdoorLabels, outdoorData, '学生人数');

            // 9. Fatigue Relief
            const reliefCounts = countOccurrences(cleanData, COLUMNS.FATIGUE_RELIEF);
            createPieChart('fatigue-relief-chart', Object.keys(reliefCounts), Object.values(reliefCounts));

            updateAllChartThemes();
        }
        
        const MD3_CHART_COLORS = ['#A37BFF', '#FF957B', '#7BFFC3', '#7BCBFF', '#FF7BCD', '#F0FF7B', '#FFB74D', '#81C784'];

        function createChart(canvasId, type, data, options) {
            const themeColors = getThemeColors();
            const ctx = document.getElementById(canvasId).getContext('2d');
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { padding: 25, color: themeColors.textColor } },
                }
            };
            chartObjects[canvasId] = new Chart(ctx, { type, data, options: { ...baseOptions, ...options } });
        }

        function createPieChart(canvasId, labels, data) {
            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: MD3_CHART_COLORS,
                    borderColor: getThemeColors().cardBgColor,
                    borderWidth: 5,
                    hoverOffset: 15
                }]
            };
            const options = {
                cutout: '55%',
                plugins: { tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw}人` } } }
            };
            createChart(canvasId, 'doughnut', chartData, options);
        }

        function createBarChart(canvasId, labels, data, label) {
            const themeColors = getThemeColors();
            const chartData = {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: themeColors.primaryAccent,
                    borderRadius: 10,
                }]
            };
            const options = {
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, title: { display: true, text: '学生人数', color: themeColors.textColor }, grid: { drawBorder: false, color: themeColors.gridColor }, ticks: { color: themeColors.textColor } },
                    x: { grid: { display: false }, ticks: { color: themeColors.textColor } }
                }
            };
            createChart(canvasId, 'bar', chartData, options);
        }
        
        function createGroupedBarChart(canvasId, labels, datasets) {
            const themeColors = getThemeColors();
            const chartData = {
                labels: labels,
                datasets: datasets.map(ds => ({...ds, borderRadius: 8 }))
            };
            const options = {
                scales: { 
                    y: { beginAtZero: true, stacked: false, title: { display: true, text: '学生人数', color: themeColors.textColor }, grid: { drawBorder: false, color: themeColors.gridColor }, ticks: { color: themeColors.textColor } },
                    x: { grid: { display: false }, ticks: { color: themeColors.textColor } }
                }
            };
            createChart(canvasId, 'bar', chartData, options);
        }
    </script>

</body>
</html>

